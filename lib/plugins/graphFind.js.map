{"version":3,"sources":["../../src/plugins/graphFind.js"],"names":["graphFind","checkIsExclusive","keys","Object","projection","shouldIncludePath","path","isExclusive","pathInProjection","some","key","startsWith","reduceSchemaRecursive","schema","reducer","initialValue","context","paths","level","maxDepth","parentArrays","parentRef","collectionName","reduce","accumulator","currentSchemaPath","options","caster","currentPaths","currentPathsString","join","nextDepth","nextParentArrays","instance","includePath","currentAccValue","ref","targetModel","db","model","targetCollectionName","collection","call","searchQueryToFilter","searchQuery","searchFields","filters","map","searchField","RegExp","$or","dotToUnderscore","property","replace","getRootGroupProperties","rootGroupProperties","pathsMeta","filter","curPath","split","$first","getJoinAndGroupPipeline","pathsToJoin","includes","undefined","length","groupedPaths","index","entry","assign","push","groupedByParentArrays","value","sort","a","b","pipeline","item","result","forEach","array","sourceArray","$unwind","preserveNullAndEmptyArrays","includeArrayIndex","parts","localField","splice","$lookup","from","foreignField","as","slice","reverse","arrayItem","nextArray","underscoredPath","arrayGroupProperty","$push","groupStep","_id","indexes","$group","nextArrayIndexProperty","$sort","$addFields","$project","getResultFilter","searchFilter","resultFilter","$and","treePathsComparator","localeCompare","skip","limit","search","type","newPath","joinAndGroupPipeline","$match","$skip","$limit","find","aggregate","allowDiskUse","exec","graphFindPlugin","static"],"mappings":"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","file":"graphFind.js","sourcesContent":["const checkIsExclusive = projection => {\r\n  const keys = Object.keys(projection);\r\n  return projection[keys[0]] === 0;\r\n};\r\n\r\nconst shouldIncludePath = (path, projection) => {\r\n  if (!projection) return true;\r\n  const keys = Object.keys(projection);\r\n  const isExclusive = checkIsExclusive(projection);\r\n  const pathInProjection = keys.some(key => isExclusive ? key === path : ( key.startsWith(path) || path.startsWith(key) ) );\r\n  return ( isExclusive && !pathInProjection ) || ( !isExclusive && pathInProjection ) ? true : false;\r\n};\r\n\r\nfunction reduceSchemaRecursive(schema, reducer, initialValue, context = {}) {\r\n  const { paths = [], level = 0, maxDepth, projection, parentArrays, parentRef, collectionName } = context;\r\n  return Object.keys(schema.paths).reduce((accumulator, path) => {\r\n    const currentSchemaPath = schema.paths[path];\r\n    const options = ( currentSchemaPath.caster && currentSchemaPath.caster.options ) || currentSchemaPath.options;\r\n    const currentPaths = [...paths, path];\r\n    const currentPathsString = currentPaths.join('.');\r\n    const nextDepth = maxDepth === true ? maxDepth : maxDepth - 1;\r\n    const nextParentArrays = currentSchemaPath.instance === 'Array' ? [...(parentArrays || []), currentPathsString] : parentArrays;\r\n    const includePath = shouldIncludePath(currentPathsString, projection);\r\n\r\n    let currentAccValue = (includePath && reducer(\r\n        accumulator,\r\n        currentPathsString,\r\n        currentSchemaPath,\r\n        options,\r\n        { level, parentArrays, parentRef, collectionName })\r\n      ) || accumulator;\r\n    if (options.ref && ( nextDepth === true || nextDepth >= 0 ) && includePath) {\r\n      const targetModel = this.db.model(options.ref);\r\n      const targetCollectionName = targetModel.collection.collectionName;\r\n      currentAccValue = reduceSchemaRecursive.call(\r\n        this,\r\n        targetModel.schema,\r\n        reducer,\r\n        currentAccValue,\r\n        {\r\n          paths: currentPaths,\r\n          level: level + 1,\r\n          maxDepth: nextDepth,\r\n          projection,\r\n          parentArrays: nextParentArrays,\r\n          parentRef: currentPathsString,\r\n          collectionName: targetCollectionName\r\n        }\r\n      );\r\n    } else if (currentSchemaPath.schema && includePath) {\r\n      currentAccValue = reduceSchemaRecursive.call(\r\n        this,\r\n        currentSchemaPath.schema,\r\n        reducer,\r\n        currentAccValue,\r\n        {\r\n          paths: currentPaths,\r\n          level,\r\n          maxDepth,\r\n          projection,\r\n          parentArrays: nextParentArrays\r\n        }\r\n      );\r\n    } \r\n    return currentAccValue;\r\n  }, initialValue);\r\n}\r\n\r\nconst searchQueryToFilter = (schema, searchQuery) => {\r\n  const { searchFields } = schema.options;\r\n  if (!searchQuery || !searchFields) return;\r\n  const filters = searchFields.map(searchField => {\r\n    return { [searchField]: new RegExp(`.*${searchQuery}.*`, 'i') };\r\n  });\r\n  return { $or: filters};\r\n};\r\n\r\nconst dotToUnderscore = property => property.replace(/\\.+/g, '_');\r\n\r\nconst getRootGroupProperties = pathsMeta => {\r\n  let rootGroupProperties = pathsMeta.filter(path => {\r\n    return path.level === 0 && path.property !== '_id';\r\n  });\r\n  rootGroupProperties = rootGroupProperties.reduce((accumulator, path) => {\r\n    // In case of nested objects, always pick the root property.\r\n    const curPath = path.property.split('.')[0];\r\n    return accumulator[curPath] ?\r\n        accumulator :\r\n        { ...accumulator, [curPath]: { $first: '$' + curPath } };\r\n  }, {});\r\n  return rootGroupProperties;\r\n};\r\n\r\nconst getJoinAndGroupPipeline = pathsMeta => {\r\n  const pathsToJoin = pathsMeta.filter(path => path.property.includes('_id') && ( path.parentRef !== undefined ));\r\n  if (!pathsToJoin.length) return [];\r\n\r\n  const rootGroupProperties = getRootGroupProperties(pathsMeta);\r\n\r\n  // Grouping by parent arrays property, so references same level deep\r\n  // should be processed by the same step\r\n  const groupedPaths = pathsToJoin.reduce((accumulator, path, index) => {\r\n    const key = ( path.parentArrays && path.parentArrays.join('_') ) || 'root';\r\n    const entry = ( accumulator[key] && Object.assign({}, accumulator[key]) ) || { parentArrays: path.parentArrays, paths: [], index };\r\n    entry.paths.push(path);\r\n    return { ...accumulator, [key]: entry };\r\n  }, {});\r\n  const groupedByParentArrays = Object.keys(groupedPaths).reduce((accumulator, key) => {\r\n    const value = groupedPaths[key];\r\n    return [...accumulator, value];\r\n  }, []).sort((a, b) => a.index > b.index ? 1 : a.index < b.index ? - 1 : 0 );\r\n\r\n  const pipeline = groupedByParentArrays.reduce((accumulator, item) => {\r\n    const result = [...accumulator];\r\n    item.parentArrays && item.parentArrays.forEach((array, index, sourceArray) => {\r\n      const curPath = '$' + array;\r\n      const $unwind = {\r\n          path: curPath,\r\n          preserveNullAndEmptyArrays: true\r\n      };\r\n      // Since grouping does not guarantee order, we have to maintain\r\n      // array indexes to restore order right after grouping\r\n      if (sourceArray.length > 1) $unwind.includeArrayIndex = 'indexes.' + dotToUnderscore(array);\r\n      result.push({ $unwind });\r\n    });\r\n\r\n    item.paths.forEach(path => {\r\n      const parts = path.property.split('.');\r\n      const localField = parts.splice(0, parts.length - 1).join('.');\r\n      result.push(\r\n        {\r\n          $lookup: {\r\n            from: path.collectionName,\r\n            localField,\r\n            foreignField: '_id',\r\n            as: localField\r\n          }\r\n        },\r\n        {\r\n          $unwind: {\r\n            path: '$' + localField,\r\n            preserveNullAndEmptyArrays: true\r\n          }\r\n        }\r\n      );\r\n    });\r\n\r\n    // Executing revere here to make sure deep nested references go first\r\n    item.parentArrays && item.parentArrays.slice(0).reverse().forEach((arrayItem, index, array) => {\r\n      const curPath = '$' + arrayItem;\r\n      const nextArray = array[index + 1];\r\n      // Since grouping does not support dot-notatation in properties,\r\n      // making some workaround here by replacing dot's with underscores and adding another\r\n      // pipeline steps to fix the issue.\r\n      const underscoredPath = arrayItem.includes('.') && dotToUnderscore(arrayItem);\r\n      const arrayGroupProperty = { [underscoredPath || arrayItem]: { $push: curPath } };\r\n\r\n      const groupStep = {\r\n        ...rootGroupProperties,\r\n        ...arrayGroupProperty\r\n      };\r\n\r\n      if (array.length === 1) {\r\n        groupStep._id = '$_id';\r\n      } else if (index < array.length - 1) {\r\n        groupStep._id = {\r\n          _id: '$_id',\r\n          // TODO: make some checks to prevent grouping array rows without ids\r\n          [underscoredPath || arrayItem]: '$' + nextArray + '._id'\r\n        };\r\n        // Indexes property will not be preserved on the last step\r\n        groupStep.indexes = { $first: '$indexes' };\r\n      } else {\r\n        groupStep._id = '$_id._id';\r\n      }\r\n\r\n      result.push({ $group: groupStep });\r\n\r\n      if (index < array.length - 1) {\r\n        const nextArrayIndexProperty = 'indexes.' + dotToUnderscore(nextArray);\r\n        result.push({ $sort: { [nextArrayIndexProperty]: 1 } });\r\n      }\r\n\r\n      if (underscoredPath) {\r\n        result.push(\r\n          {\r\n            $addFields: { [arrayItem]: '$' + underscoredPath }\r\n          },\r\n          {\r\n            $project: { [underscoredPath]: 0 }\r\n          }\r\n        );\r\n      }\r\n    });\r\n\r\n    return result;\r\n  }, []);\r\n\r\n  return pipeline;\r\n};\r\n\r\nconst getResultFilter = (filter, searchFilter) => {\r\n  if (!filter && !searchFilter) return;\r\n  const resultFilter = [];\r\n  filter && resultFilter.push(filter);\r\n  searchFilter && resultFilter.push(searchFilter);\r\n  return resultFilter.length === 1 ? resultFilter[0] : { $and: resultFilter };\r\n};\r\n\r\nconst treePathsComparator = (a, b) => {\r\n  if (a.level > b.level) return 1;\r\n  else if (a.level < b.level) return -1;\r\n  else return a.property.localeCompare(b.property);\r\n};\r\n\r\nexport function graphFind(options = {}) {\r\n\r\n  const { skip, limit, projection, filter, sort, search } = options;\r\n  let maxDepth;\r\n  if (options.maxDepth || options.maxDepth === 0) maxDepth = options.maxDepth;\r\n  else if (this.schema.options.maxDepth || this.schema.options.maxDepth === 0) maxDepth = this.schema.options.maxDepth;\r\n  else maxDepth = 1;\r\n\r\n  const pathsMeta = reduceSchemaRecursive.call(this, this.schema, (accumulator, property, schema, options, context) => {\r\n    let type;\r\n    if (schema.instance === 'Array') type = 'array';\r\n    else if (schema.schema) type = 'schema';\r\n    else if (options.ref) type = 'ref';\r\n    else type = 'path';\r\n    const newPath = { property, type, ...context };\r\n    return [...accumulator, newPath];\r\n  }, [], { maxDepth, projection }).sort(treePathsComparator);\r\n\r\n  const pipeline = [];\r\n\r\n  const searchFilter = searchQueryToFilter(this.schema, search);\r\n  const resultFilter = getResultFilter(filter, searchFilter);\r\n\r\n  const joinAndGroupPipeline = getJoinAndGroupPipeline(pathsMeta, projection, maxDepth);\r\n  joinAndGroupPipeline && pipeline.push(...joinAndGroupPipeline);\r\n\r\n  resultFilter && pipeline.push({ $match: resultFilter });\r\n  projection && pipeline.push({ $project: projection });\r\n  sort && pipeline.push({ $sort: sort });\r\n  skip && pipeline.push({ $skip: skip });\r\n  limit && pipeline.push({ $limit: limit });\r\n\r\n  return pipeline.length === 0 ? this.find() : this.aggregate(pipeline).allowDiskUse(true).exec();\r\n\r\n}\r\n\r\nconst graphFindPlugin = schema => {\r\n  schema.static('graphFind', graphFind);\r\n  schema.static('graphFindOne', async function(options) {\r\n    const result = await graphFind({ ...options, limit: 1 });\r\n    return result.length > 0 ? result[0] : null;\r\n  });\r\n};\r\n\r\nexport default graphFindPlugin;"]}
{"version":3,"sources":["../../src/router/crud.js"],"names":["crudRouter","Model","opts","router","routeMap","createRouteMap","rootRouter","route","getAll","get","addOne","post","idRouter","getOne","updateOne","put","deleteOne","delete","defaultOpts","defaultPageSize","delimiter","createGetAll","createAddOne","createGetOne","createUpdateOne","createDeleteOne","errorHandler","err","res","next","name","status","json","req","locals","user","i18n","query","page","size","filter","sort","find","setOptions","skip","limit","where","exec","result","countQuery","count","totalCount","lastPage","Math","max","ceil","prev","nextPage","min","link","LinkHeader","set","uri","querystring","stringify","rel","toString","doc","body","save","instance","findById","_id","created","location","getLocation","toObject","id","findOne","params","findOneAndUpdate","runValidators","context","updatedInstance","findOneAndDelete","send"],"mappings":"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","file":"crud.js","sourcesContent":["import { Router } from \"express\";\r\nimport querystring from \"querystring\";\r\nimport LinkHeader from \"http-link-header\";\r\nimport { getCurrentUrl, asyncMiddleware } from \"../utils/http\";\r\n\r\nconst crudRouter = (Model, opts) => {\r\n\r\n    const router = Router();\r\n    const routeMap = createRouteMap(Model, opts);\r\n\r\n    const rootRouter = router.route(\"/\");\r\n    routeMap.getAll && rootRouter.get(routeMap.getAll);\r\n    routeMap.addOne && rootRouter.post(routeMap.addOne);\r\n\r\n    const idRouter = router.route(\"/:id\");\r\n    routeMap.getOne && idRouter.get(routeMap.getOne);\r\n    routeMap.updateOne && idRouter.put(routeMap.updateOne);\r\n    routeMap.deleteOne && idRouter.delete(routeMap.deleteOne);\r\n\r\n    return router;\r\n\r\n};\r\n\r\nconst defaultOpts = {\r\n    defaultPageSize: 20,\r\n    delimiter: \",\"\r\n};\r\n\r\nconst createRouteMap = (Model, opts = defaultOpts) => {\r\n\r\n    const routeMap = {\r\n        getAll: createGetAll(Model, opts),\r\n        addOne: createAddOne(Model, opts),\r\n        getOne: createGetOne(Model, opts),\r\n        updateOne: createUpdateOne(Model, opts),\r\n        deleteOne: createDeleteOne(Model, opts)\r\n    };\r\n\r\n    return routeMap;\r\n\r\n};\r\n\r\nconst errorHandler = (err, res, next) => {\r\n    if (err.name !== \"ValidationError\") return next(err);\r\n    res.status(400).json(err);\r\n};\r\n\r\nexport const createGetAll = (Model, opts = defaultOpts) => asyncMiddleware(async (req, res) => {\r\n\r\n    opts = { ...defaultOpts, ...opts };\r\n\r\n    const { defaultPageSize } = opts;\r\n    const { user, i18n } = res.locals;\r\n\r\n    let { page, size, filter, sort } = req.query;\r\n    page = (page && page * 1) || 0;\r\n    size = (size && size * 1) || defaultPageSize;\r\n\r\n    const query = Model.find()\r\n        .setOptions({ i18n, user })\r\n        .skip(page * size)\r\n        .limit(size);\r\n\r\n    if (filter) query.where(filter);\r\n    if (sort) query.sort(sort);\r\n\r\n    let result = await query.exec();\r\n\r\n    const countQuery = Model.count().setOptions({ i18n, user });\r\n    if (filter) countQuery.where(filter);\r\n\r\n    let totalCount = await countQuery.exec();\r\n    \r\n    const lastPage = Math.max(Math.ceil(totalCount / size) - 1, 0);\r\n    const prev = Math.max(page - 1, 0);\r\n    const nextPage = Math.min(page + 1, totalCount, lastPage);\r\n\r\n    const link = new LinkHeader();\r\n    link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: 0, size })}`, rel: \"first\" }); \r\n    page > 0 && link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: prev, size })}`, rel: \"previous\" });\r\n    page < lastPage && link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: nextPage, size })}`, rel: \"next\" });\r\n    link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: lastPage, size })}`, rel: \"last\" });\r\n\r\n    res.set(\"X-Total-Count\", totalCount);\r\n    res.set(\"Link\", link.toString());\r\n    res.json(result);\r\n\r\n}, (err, req, res, next) => errorHandler(err, res, next));\r\n\r\nexport const createAddOne = Model => asyncMiddleware(async (req, res) => {\r\n\r\n    const { user, i18n } = res.locals;\r\n    const doc = new Model(req.body);\r\n    \r\n    doc.setOptions && doc.setOptions({ user, i18n });\r\n    \r\n    let instance = await doc.save();\r\n    let created = await Model.findById(instance._id).setOptions({ user, i18n });\r\n\r\n    res.status(201).location(getLocation(req, created._id)).json(created.toObject());\r\n\r\n}, (err, req, res, next) => errorHandler(err, res, next));\r\n\r\nexport const getLocation = (req, id) => `${getCurrentUrl(req)}/${id}`;\r\n\r\nexport const createGetOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { user, i18n } = res.locals;\r\n    let instance = await Model.findOne({ _id: req.params.id }).setOptions({ user, i18n });\r\n    instance ? res.json(instance) : next();\r\n}, (err, req, res, next) => errorHandler(err, res, next));\r\n\r\nexport const createUpdateOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { user, i18n } = res.locals;\r\n    const instance = await Model.findOneAndUpdate({ _id: req.params.id }, req.body, { runValidators: true, context: 'query', i18n, user });\r\n    if (!instance) return next();\r\n    const updatedInstance = await Model.findById(instance._id).setOptions({ user, i18n });\r\n    updatedInstance && res.json(updatedInstance);\r\n}, (err, req, res, next) => errorHandler(err, res, next));\r\n\r\nexport const createDeleteOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { user, i18n } = res.locals;\r\n    const instance = await Model.findOneAndDelete({ _id: req.params.id }).setOptions({ user, i18n });\r\n    instance ? res.status(204).send() : next();\r\n}, (err, req, res, next) => errorHandler(err, res, next));\r\n\r\nexport default crudRouter;"]}
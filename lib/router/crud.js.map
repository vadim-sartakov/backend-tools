{"version":3,"sources":["../../src/router/crud.js"],"names":["defaultOptions","defaultPageSize","createMiddlewareChain","createMiddleware","Model","options","securitySchema","validationSchema","crudMiddleware","chain","push","crudRouter","router","rootRouter","route","disableGetAll","get","createGetAll","disableAddOne","post","createAddOne","idRouter","disableGetOne","createGetOne","disableUpdateOne","put","createUpdateOne","disableDeleteOne","delete","createDeleteOne","req","res","permissions","locals","query","page","size","filter","sort","getAll","result","count","undefined","totalCount","lastPage","Math","max","ceil","prev","nextPage","min","link","LinkHeader","set","uri","querystring","stringify","rel","toString","json","getLocation","id","addOne","body","instance","status","location","next","getOne","params","updateOne","deleteOne","send"],"mappings":"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","file":"crud.js","sourcesContent":["import { Router } from \"express\";\r\nimport querystring from \"querystring\";\r\nimport LinkHeader from \"http-link-header\";\r\nimport { getCurrentUrl, asyncMiddleware } from \"../utils/http\";\r\nimport { permissions, validator } from \"../middleware\";\r\n\r\nconst defaultOptions = {\r\n    defaultPageSize: 20\r\n};\r\n\r\nconst createMiddlewareChain = (createMiddleware, Model, options) => {\r\n    const { securitySchema, validationSchema } = options;\r\n    const crudMiddleware = createMiddleware(Model, options);\r\n    const chain = [];\r\n    if (securitySchema) chain.push(permissions(securitySchema));\r\n    if (validationSchema) chain.push(validator(validationSchema));\r\n    chain.push(crudMiddleware);\r\n    return chain;\r\n};\r\n\r\nconst crudRouter = (Model, options) => {\r\n    options = { ...defaultOptions, ...options };\r\n    const router = Router();\r\n    const rootRouter = router.route(\"/\");\r\n    !options.disableGetAll && rootRouter.get(createMiddlewareChain(createGetAll, Model, options));\r\n    !options.disableAddOne && rootRouter.post(createMiddlewareChain(createAddOne, Model, options));\r\n    const idRouter = router.route(\"/:id\");\r\n    !options.disableGetOne && idRouter.get(createMiddlewareChain(createGetOne, Model, options));\r\n    !options.disableUpdateOne && idRouter.put(createMiddlewareChain(createUpdateOne, Model, options));\r\n    !options.disableDeleteOne && idRouter.delete(createMiddlewareChain(createDeleteOne, Model, options));\r\n    return router;\r\n};\r\n\r\nconst createGetAll = (Model, options) => asyncMiddleware(async (req, res) => {\r\n\r\n    const { defaultPageSize } = options;\r\n    const { permissions } = res.locals;\r\n\r\n    let { page, size, filter, sort } = req.query;\r\n    // Converting to number by multiplying by 1\r\n    page = (page && page * 1) || 0;\r\n    size = (size && size * 1) || defaultPageSize;\r\n\r\n    const result = await Model.getAll({ page, size, filter, sort }, permissions);\r\n    let totalCount = await Model.count(filter, undefined);\r\n    \r\n    const lastPage = Math.max(Math.ceil(totalCount / size) - 1, 0);\r\n    const prev = Math.max(page - 1, 0);\r\n    const nextPage = Math.min(page + 1, totalCount, lastPage);\r\n\r\n    const link = new LinkHeader();\r\n    link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: 0, size })}`, rel: \"first\" }); \r\n    page > 0 && link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: prev, size })}`, rel: \"previous\" });\r\n    page < lastPage && link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: nextPage, size })}`, rel: \"next\" });\r\n    link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: lastPage, size })}`, rel: \"last\" });\r\n\r\n    res.set(\"X-Total-Count\", totalCount);\r\n    res.set(\"Link\", link.toString());\r\n    res.json(result);\r\n\r\n});\r\n\r\nconst getLocation = (req, id) => `${getCurrentUrl(req)}/${id}`;\r\n\r\nconst createAddOne = Model => asyncMiddleware(async (req, res) => {\r\n    const { permissions } = res.locals;\r\n    let instance = await Model.addOne(req.body, permissions);\r\n    res.status(201).location(getLocation(req, instance.id)).json(instance);\r\n});\r\n\r\nconst createGetOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { permissions } = res.locals;\r\n    let instance = await Model.getOne({ id: req.params.id }, permissions);\r\n    instance ? res.json(instance) : next();\r\n});\r\n\r\nconst createUpdateOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { permissions } = res.locals;\r\n    const instance = await Model.updateOne({ id: req.params.id }, req.body, permissions);\r\n    return instance ? res.json(instance) : next();\r\n});\r\n\r\nconst createDeleteOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { permissions } = res.locals;\r\n    const instance = await Model.deleteOne({ id: req.params.id }, permissions);\r\n    return instance ? res.status(204).send() : next();\r\n});\r\n\r\nexport default crudRouter;"]}
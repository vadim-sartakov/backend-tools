{"version":3,"sources":["../../src/router/crud.js"],"names":["defaultOptions","defaultPageSize","createMiddlewareChain","createMiddleware","Model","options","applyValidator","crudMiddleware","securitySchema","validationSchema","logger","chain","push","crudRouter","router","rootRouter","route","disableGetAll","get","createGetAll","disableAddOne","post","createAddOne","idRouter","disableGetOne","createGetOne","disableUpdateOne","put","createUpdateOne","disableDeleteOne","delete","createDeleteOne","req","res","search","permissions","locals","query","page","size","filter","sort","JSON","parse","err","Object","assign","getAll","result","count","undefined","totalCount","lastPage","Math","max","ceil","prev","nextPage","min","link","LinkHeader","set","uri","querystring","stringify","rel","toString","json","getLocation","id","addOne","body","instance","_id","getOne","status","location","next","params","returnInstanceOrContinue","updateOne","deleteOne","end"],"mappings":"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","file":"crud.js","sourcesContent":["import { Router } from \"express\";\r\nimport querystring from \"querystring\";\r\nimport LinkHeader from \"http-link-header\";\r\nimport { getCurrentUrl, asyncMiddleware } from \"../utils/http\";\r\nimport { security, validator } from \"../middleware\";\r\n\r\nconst defaultOptions = {\r\n    defaultPageSize: 20\r\n};\r\n\r\nconst createMiddlewareChain = (createMiddleware, Model, options, applyValidator) => {\r\n    const crudMiddleware = createMiddleware(Model, options);\r\n    const { securitySchema, validationSchema, logger } = options;\r\n    const chain = [];\r\n    if (securitySchema) chain.push(security(securitySchema, logger));\r\n    if (applyValidator && validationSchema) chain.push(validator(validationSchema));\r\n    chain.push(crudMiddleware);\r\n    return chain;\r\n};\r\n\r\nconst crudRouter = (Model, options) => {\r\n    options = { ...defaultOptions, ...options };\r\n    const router = Router();\r\n    const rootRouter = router.route(\"/\");\r\n    !options.disableGetAll && rootRouter.get(createMiddlewareChain(createGetAll, Model, options));\r\n    !options.disableAddOne && rootRouter.post(createMiddlewareChain(createAddOne, Model, options, true));\r\n    const idRouter = router.route(\"/:id\");\r\n    !options.disableGetOne && idRouter.get(createMiddlewareChain(createGetOne, Model, options));\r\n    !options.disableUpdateOne && idRouter.put(createMiddlewareChain(createUpdateOne, Model, options, true));\r\n    !options.disableDeleteOne && idRouter.delete(createMiddlewareChain(createDeleteOne, Model, options));\r\n    return router;\r\n};\r\n\r\nconst createGetAll = (Model, options) => asyncMiddleware(async (req, res) => {\r\n\r\n    const { defaultPageSize, search } = options;\r\n    const { permissions } = res.locals;\r\n\r\n    let { page, size, filter, sort } = req.query;\r\n\r\n    if (filter) {\r\n        try {\r\n            filter = JSON.parse(filter);\r\n        } catch(err) { } // eslint-disable-line no-empty\r\n    }\r\n    if (sort) {\r\n        try {\r\n            sort = JSON.parse(sort);\r\n        } catch(err) { } // eslint-disable-line no-empty\r\n    }\r\n    // Converting to number by multiplying by 1\r\n    page = (page && page * 1) || 0;\r\n    size = (size && size * 1) || defaultPageSize;\r\n\r\n    if (filter && filter.search && search) {\r\n        Object.assign(filter, search(filter.search));\r\n        delete filter.search;\r\n    }\r\n\r\n    const result = await Model.getAll({ page, size, filter, sort }, permissions);\r\n    let totalCount = await Model.count(filter, undefined);\r\n    \r\n    const lastPage = Math.max(Math.ceil(totalCount / size) - 1, 0);\r\n    const prev = Math.max(page - 1, 0);\r\n    const nextPage = Math.min(page + 1, totalCount, lastPage);\r\n\r\n    const link = new LinkHeader();\r\n    link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: 0, size })}`, rel: \"first\" }); \r\n    page > 0 && link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: prev, size })}`, rel: \"previous\" });\r\n    page < lastPage && link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: nextPage, size })}`, rel: \"next\" });\r\n    link.set({ uri: `${getCurrentUrl(req)}?${querystring.stringify({ page: lastPage, size })}`, rel: \"last\" });\r\n\r\n    res.set(\"X-Total-Count\", totalCount);\r\n    res.set(\"Link\", link.toString());\r\n    res.json(result);\r\n\r\n});\r\n\r\nconst getLocation = (req, id) => `${getCurrentUrl(req)}/${id}`;\r\n\r\nconst createAddOne = Model => asyncMiddleware(async (req, res) => {\r\n    const { permissions } = res.locals;\r\n    let instance = await Model.addOne(req.body, permissions);\r\n    const id = instance._id || instance.id;\r\n    instance = await Model.getOne({ id }, permissions);\r\n    res.status(201).location(getLocation(req, instance._id || instance.id)).json(instance);\r\n});\r\n\r\nconst createGetOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { permissions } = res.locals;\r\n    let instance = await Model.getOne({ id: req.params.id }, permissions);\r\n    instance ? res.json(instance) : next();\r\n});\r\n\r\nconst returnInstanceOrContinue = async (Model, instance, req, res, next) => {\r\n    if (instance) {\r\n        instance = await Model.getOne({ id: req.params.id }, res.locals.permissions);\r\n        res.json(instance);\r\n    } else {\r\n        next();\r\n    }\r\n};\r\n\r\nconst createUpdateOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { permissions } = res.locals;\r\n    let instance = await Model.updateOne({ id: req.params.id }, req.body, permissions);\r\n    await returnInstanceOrContinue(Model, instance, req, res, next);\r\n});\r\n\r\nconst createDeleteOne = Model => asyncMiddleware(async (req, res, next) => {\r\n    const { permissions } = res.locals;\r\n    const instance = await Model.deleteOne({ id: req.params.id }, permissions);\r\n    return instance ? res.status(204).end() : next();\r\n});\r\n\r\nexport default crudRouter;"]}
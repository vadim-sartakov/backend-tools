{"version":3,"sources":["../../src/model/MongooseCrudModel.js"],"names":["defaultPermissions","create","read","update","delete","MongooseCrudModel","Model","opts","excerptProjection","populate","queryFilter","permissionFilter","filterArray","push","resultFilter","length","$and","permissions","page","size","filter","sort","permissionProjection","projection","getAllQuery","find","skip","limit","select","getResultFilter","where","applyPopulateIfRequired","setOptions","lean","exec","query","Object","keys","forEach","path","countQuery","count","payload","doc","save","saved","toObject","convertFitlerId","findOne","result","id","_id","initialObject","findOneAndUpdate","new","updated","findOneAndDelete","deleted"],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,IAAMA,qBAAqB,EAAEC,QAAQ,EAAV,EAAeC,MAAM,EAArB,EAA0BC,QAAQ,EAAlC,EAAuCC,QAAQ,EAA/C,EAA3B;;IAEMC,iB;AAEF,+BAAYC,KAAZ,EAA8B;AAAA,YAAXC,IAAW,uEAAJ,EAAI;;AAAA;;AAAA,YAClBC,iBADkB,GACcD,IADd,CAClBC,iBADkB;AAAA,YACCC,QADD,GACcF,IADd,CACCE,QADD;;AAE1B,aAAKH,KAAL,GAAaA,KAAb;AACA,aAAKE,iBAAL,GAAyBA,iBAAzB;AACA,aAAKC,QAAL,GAAgBA,QAAhB;AACH;;;;wCAEeC,W,EAAaC,gB,EAAkB;AAC3C,gBAAMC,cAAc,EAApB;AACA,gBAAID,gBAAJ,EAAsBC,YAAYC,IAAZ,CAAiBF,gBAAjB;AACtB,gBAAID,WAAJ,EAAiBE,YAAYC,IAAZ,CAAiBH,WAAjB;AACjB,gBAAII,qBAAJ;AACA,oBAAOF,YAAYG,MAAnB;AACI,qBAAK,CAAL;AACID,mCAAeF,YAAY,CAAZ,CAAf;AACA;AACJ,qBAAK,CAAL;AACIE,mCAAe,EAAEE,MAAMJ,WAAR,EAAf;AACA;AACJ;AAPJ;AASA,mBAAOE,YAAP;AACH;;;;uGAE0CG,W;oBAA5BC,I,QAAAA,I;oBAAMC,I,QAAAA,I;oBAAMC,M,QAAAA,M;oBAAQC,I,QAAAA,I;;;;;;;;AAC/BJ,2DAAmBjB,kBAAnB,EAA0CiB,WAA1C;+CACiFA,W,mCAAzEf,I,EAAgBS,gB,qBAARS,M,EAAsCE,oB,qBAAZC,U;AACpCC,2C,GAAc,KAAKlB,KAAL,CAAWmB,IAAX,GACfC,IADe,CACVR,OAAOC,IADG,EAEfQ,KAFe,CAETR,IAFS,C;AAGdI,0C,GAAa,KAAKf,iBAAL,IAA0Bc,oB;;AAC7C,oCAAIC,UAAJ,EAAgBC,YAAYI,MAAZ,CAAmBL,UAAnB;AACVT,4C,GAAe,KAAKe,eAAL,CAAqBT,MAArB,EAA6BT,gBAA7B,C;;AACrB,oCAAIG,YAAJ,EAAkBU,YAAYM,KAAZ,CAAkBhB,YAAlB;AAClB,oCAAIO,IAAJ,EAAUG,YAAYH,IAAZ,CAAiBA,IAAjB;AACV,qCAAKU,uBAAL,CAA6BP,WAA7B;AACAA,4CAAYQ,UAAZ,CAAuB,EAAEC,MAAM,IAAR,EAAvB;;uCACaT,YAAYU,IAAZ,E;;;;;;;;;;;;;;;;;;;;;gDAGOC,K,EAAO;AAAA;;AAC3B,gBAAI,KAAK1B,QAAT,EAAmB2B,OAAOC,IAAP,CAAY,KAAK5B,QAAjB,EAA2B6B,OAA3B,CAAmC;AAAA,uBAAQH,MAAM1B,QAAN,CAAe,EAAE8B,UAAF,EAAQX,QAAQ,MAAKnB,QAAL,CAAc8B,IAAd,CAAhB,EAAf,CAAR;AAAA,aAAnC;AACtB;;;;kGAEWnB,M,EAAQH,W;;;;;;;AAChBA,2DAAmBjB,kBAAnB,EAA0CiB,WAA1C;gDAC+CA,W,EAAvBN,gB,iBAAhBT,I,CAAQkB,M;AACVoB,0C,GAAa,KAAKlC,KAAL,CAAWmC,KAAX,E;AACb3B,4C,GAAe,KAAKe,eAAL,CAAqBT,MAArB,EAA6BT,gBAA7B,C;;AACrB,oCAAIG,YAAJ,EAAkB0B,WAAWV,KAAX,CAAiBhB,YAAjB;;uCACL0B,WAAWN,IAAX,E;;;;;;;;;;;;;;;;;;;;;;kGAGJQ,O,EAASzB,W;;;;;;;AAClBA,2DAAmBjB,kBAAnB,EAA0CiB,WAA1C;gDACmCA,W,EAAjBM,U,iBAAVpB,M,CAAUoB,U;;AAClB,oCAAIA,UAAJ,EAAgBmB,UAAU,+BAAaA,OAAb,EAAsBnB,UAAtB,CAAV;AACVoB,mC,GAAM,IAAI,KAAKrC,KAAT,CAAeoC,OAAf,C;;uCACMC,IAAIC,IAAJ,E;;;AAAdC,qC;kEACGA,MAAMC,QAAN,E;;;;;;;;;;;;;;;;;;;kGAGE1B,M,EAAQH,W;;;;;;;AACjBG,yCAAS,KAAK2B,eAAL,CAAqB3B,MAArB,CAAT;AACAH,2DAAmBjB,kBAAnB,EAA0CiB,WAA1C;gDAC2DA,W,qCAAnDf,I,EAAgBS,gB,sBAARS,M,EAA0BG,U,sBAAAA,U;AACpCT,4C,GAAe,KAAKe,eAAL,CAAqBT,MAArB,EAA6BT,gBAA7B,C;AACfwB,qC,GAAQ,KAAK7B,KAAL,CAAW0C,OAAX,CAAmBlC,YAAnB,C;;AACd,oCAAIS,UAAJ,EAAgBY,MAAMP,MAAN,CAAaL,UAAb;AAChB,qCAAKQ,uBAAL,CAA6BI,KAA7B;AACAA,sCAAMH,UAAN,CAAiB,EAAEC,MAAM,IAAR,EAAjB;;uCACaE,MAAMD,IAAN,E;;;;;;;;;;;;;;;;;;;;;wCAGDd,M,EAAQ;AACpB,gBAAI6B,eAAJ;AACA,gBAAI7B,UAAUA,OAAO8B,EAArB,EAAyB;AACrBD,sCAAc7B,MAAd;AACA6B,uBAAOE,GAAP,GAAaF,OAAOC,EAApB;AACA,uBAAOD,OAAOC,EAAd;AACH;AACD,mBAAOD,MAAP;AACH;;;;kGAEe7B,M,EAAQsB,O,EAASzB,W;;;;;;;AAC7BG,yCAAS,KAAK2B,eAAL,CAAqB3B,MAArB,CAAT;AACAH,2DAAmBjB,kBAAnB,EAA0CiB,WAA1C;gDACuEA,W,EAA/CN,gB,iBAAhBT,I,CAAQkB,M,EAAsCG,U,iBAAVpB,M,CAAUoB,U;AAChDT,4C,GAAe,KAAKe,eAAL,CAAqBT,MAArB,EAA6BT,gBAA7B,C;;qCACjBY,U;;;;;;uCAC4B,KAAKjB,KAAL,CAAW0C,OAAX,CAAmBlC,YAAnB,EAAiCmB,IAAjC,E;;;AAAtBmB,6C;;AACNV,0CAAU,+BAAaA,OAAb,EAAsBnB,UAAtB,EAAkC6B,aAAlC,CAAV;;;;uCAEkB,KAAK9C,KAAL,CAAW+C,gBAAX,CAA4BvC,YAA5B,EAA0C4B,OAA1C,EAAmD,EAAEY,KAAK,IAAP,EAAarB,MAAM,IAAnB,EAAnD,C;;;AAAhBsB,uC;kEACCA,O;;;;;;;;;;;;;;;;;;;kGAGKnC,M,EAAQH,W;;;;;;;AACpBG,yCAAS,KAAK2B,eAAL,CAAqB3B,MAArB,CAAT;AACAH,2DAAmBjB,kBAAnB,EAA0CiB,WAA1C;gDAC+CA,W,EAAvBN,gB,iBAAhBT,I,CAAQkB,M;AACVN,4C,GAAe,KAAKe,eAAL,CAAqBT,MAArB,EAA6BT,gBAA7B,C;;uCACD,KAAKL,KAAL,CAAWkD,gBAAX,CAA4B1C,YAA5B,EAA0CmB,IAA1C,E;;;AAAhBwB,uC;kEACGA,O;;;;;;;;;;;;;;;;;;;;;kBAKApD,iB","file":"MongooseCrudModel.js","sourcesContent":["import { filterObject } from \"shared-tools\";\r\n\r\nconst defaultPermissions = { create: { }, read: { }, update: { }, delete: { } };\r\n\r\nclass MongooseCrudModel {\r\n\r\n    constructor(Model, opts = {}) {\r\n        const { excerptProjection, populate } = opts;\r\n        this.Model = Model;\r\n        this.excerptProjection = excerptProjection;\r\n        this.populate = populate;\r\n    }\r\n\r\n    getResultFilter(queryFilter, permissionFilter) {\r\n        const filterArray = [];\r\n        if (permissionFilter) filterArray.push(permissionFilter);\r\n        if (queryFilter) filterArray.push(queryFilter);\r\n        let resultFilter;\r\n        switch(filterArray.length) {\r\n            case 1:\r\n                resultFilter = filterArray[0];\r\n                break;\r\n            case 2:\r\n                resultFilter = { $and: filterArray };\r\n                break;\r\n            default:\r\n        }\r\n        return resultFilter;\r\n    }\r\n\r\n    async getAll({ page, size, filter, sort }, permissions) {\r\n        permissions = { ...defaultPermissions, ...permissions };\r\n        const { read: { filter: permissionFilter, projection: permissionProjection } } = permissions;\r\n        const getAllQuery = this.Model.find()\r\n            .skip(page * size)\r\n            .limit(size);\r\n        const projection = this.excerptProjection || permissionProjection;\r\n        if (projection) getAllQuery.select(projection);\r\n        const resultFilter = this.getResultFilter(filter, permissionFilter);\r\n        if (resultFilter) getAllQuery.where(resultFilter);\r\n        if (sort) getAllQuery.sort(sort);\r\n        this.applyPopulateIfRequired(getAllQuery);\r\n        getAllQuery.setOptions({ lean: true });\r\n        return await getAllQuery.exec();\r\n    }\r\n\r\n    applyPopulateIfRequired(query) {\r\n        if (this.populate) Object.keys(this.populate).forEach(path => query.populate({ path, select: this.populate[path] }));\r\n    }\r\n\r\n    async count(filter, permissions) {\r\n        permissions = { ...defaultPermissions, ...permissions };\r\n        const { read: { filter: permissionFilter } } = permissions;\r\n        const countQuery = this.Model.count();\r\n        const resultFilter = this.getResultFilter(filter, permissionFilter);\r\n        if (resultFilter) countQuery.where(resultFilter);\r\n        return await countQuery.exec();\r\n    }\r\n\r\n    async addOne(payload, permissions) {\r\n        permissions = { ...defaultPermissions, ...permissions };\r\n        const { update: { projection } } = permissions;\r\n        if (projection) payload = filterObject(payload, projection);\r\n        const doc = new this.Model(payload);\r\n        let saved = await doc.save();\r\n        return saved.toObject();\r\n    }\r\n\r\n    async getOne(filter, permissions) {\r\n        filter = this.convertFitlerId(filter);\r\n        permissions = { ...defaultPermissions, ...permissions };\r\n        const { read: { filter: permissionFilter, projection } } = permissions;\r\n        const resultFilter = this.getResultFilter(filter, permissionFilter);\r\n        const query = this.Model.findOne(resultFilter);\r\n        if (projection) query.select(projection);\r\n        this.applyPopulateIfRequired(query);\r\n        query.setOptions({ lean: true });\r\n        return await query.exec();\r\n    }\r\n\r\n    convertFitlerId(filter) {\r\n        let result;\r\n        if (filter && filter.id) {\r\n            result = { ...filter };\r\n            result._id = result.id;\r\n            delete result.id;\r\n        }\r\n        return result;\r\n    }\r\n\r\n    async updateOne(filter, payload, permissions) {\r\n        filter = this.convertFitlerId(filter);\r\n        permissions = { ...defaultPermissions, ...permissions };\r\n        const { read: { filter: permissionFilter }, update: { projection } } = permissions;\r\n        const resultFilter = this.getResultFilter(filter, permissionFilter);\r\n        if (projection) {\r\n            const initialObject = await this.Model.findOne(resultFilter).lean();\r\n            payload = filterObject(payload, projection, initialObject);\r\n        }\r\n        const updated = await this.Model.findOneAndUpdate(resultFilter, payload, { new: true, lean: true });\r\n        return updated;\r\n    }\r\n\r\n    async deleteOne(filter, permissions) {\r\n        filter = this.convertFitlerId(filter);\r\n        permissions = { ...defaultPermissions, ...permissions };\r\n        const { read: { filter: permissionFilter } } = permissions;\r\n        const resultFilter = this.getResultFilter(filter, permissionFilter);\r\n        let deleted = await this.Model.findOneAndDelete(resultFilter).lean();\r\n        return deleted;\r\n    }\r\n\r\n}\r\n\r\nexport default MongooseCrudModel;"]}
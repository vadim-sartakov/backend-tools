{"version":3,"sources":["../../src/plugin/security.js"],"names":["ALL","ADMIN","ADMIN_READ","getPermissions","security","user","action","projectionToObject","projection","split","reduce","prev","field","excluding","startsWith","replace","roles","prevPermission","role","rolePermissions","permission","where","push","prevProj","curProj","securityPlugin","or","_update","normalizeSet","handleRestricted","path","onUpdate","schema","methods","setOptions","options","_options","createSecurityHandler","callback","constructor","name","permissions","Promise","reject","AccessDeniedError","call","querySecurityHandler","result","cur","isArray","Array","_","get","object","value","handler","exclusive","Object","keys","excludeFilter","filter","forEach","onSave","normalizedDoc","_doc","set","undefined","onRead","select","pre"],"mappings":";;;;;;;;;;;AAAA;;;;AACA;;AACA;;;;;;;;;;AAEA,IAAMA,MAAM,KAAZ;AACA,IAAMC,QAAQ,OAAd;AACA,IAAMC,aAAa,YAAnB;;AAEO,IAAMC,0CAAiB,SAAjBA,cAAiB,CAACC,QAAD,EAAWC,IAAX,EAAiBC,MAAjB,EAA4B;;AAEtD,QAAI,CAACD,IAAL,EAAW,OAAO,IAAP;;AAEX,QAAME,qBAAqB,SAArBA,kBAAqB,aAAc;AACrC,YAAI,QAAOC,UAAP,yCAAOA,UAAP,OAAsB,QAA1B,EAAoC,OAAOA,UAAP;AACpC,eAAOA,WAAWC,KAAX,CAAiB,GAAjB,EAAsBC,MAAtB,CAA6B,UAACC,IAAD,EAAOC,KAAP,EAAiB;AACjD,gBAAMC,YAAYD,MAAME,UAAN,CAAiB,GAAjB,CAAlB;AACA,gBAAID,SAAJ,EAAeD,QAAQA,MAAMG,OAAN,CAAc,GAAd,EAAmB,EAAnB,CAAR;AACf,gCAAYJ,IAAZ,sBAAmBC,KAAnB,EAA2BC,YAAY,CAAZ,GAAgB,CAA3C;AACH,SAJM,EAIJ,EAJI,CAAP;AAKH,KAPD;;AASA,WAAOR,KAAKW,KAAL,CAAWN,MAAX,CAAkB,UAACO,cAAD,EAAiBC,IAAjB,EAA0B;;AAE/C,YAAID,mBAAmB,IAAnB,IACKC,SAASjB,KAAT,IAAkB,CAACG,SAASH,KAA5B,IAAqC,CAACG,SAASJ,GADpD,IAEKM,WAAW,MAAX,IAAqBY,SAAShB,UAA9B,IAA4C,CAACE,SAASF,UAAtD,IAAoE,CAACE,SAASJ,GAFvF,EAE6F;AACzF,mBAAO,IAAP;AACH;;AAED,YAAI,CAACI,QAAL,EAAe,OAAO,KAAP;;AAEf,YAAMe,kBAAkBf,SAASc,IAAT,KAAkBd,SAASJ,GAAT,CAAlB,IAAmC,EAA3D;AACA,YAAIoB,aAAaD,gBAAgBb,MAAhB,CAAjB;AACA,YAAIc,eAAe,IAAnB,EAAyB;AACrB,mBAAO,IAAP;AACH;;AAED,YAAI,CAACA,UAAL,EAAiB;AACb,mBAAOH,cAAP;AACH;;AAED,YAAI,QAAOE,eAAP,yCAAOA,eAAP,OAA2B,QAA/B,EAAyC;AACrC,mBAAOF,cAAP;AACH;;AAED,YAAII,cAAJ;AACA,YAAID,WAAWC,KAAf,EAAsB;AAClBA,oBAAQJ,eAAeI,KAAf,IAAwB,EAAhC;AACAA,kBAAMC,IAAN,CAAWF,WAAWC,KAAX,CAAiBhB,IAAjB,CAAX;AACH;AACD,YAAMkB,WAAYN,eAAeT,UAAf,IAA6BD,mBAAmBU,eAAeT,UAAlC,CAA9B,IAAgF,EAAjG;AACA,YAAMgB,UAAWJ,WAAWZ,UAAX,IAAyBD,mBAAmBa,WAAWZ,UAA9B,CAA1B,IAAwE,EAAxF;;AAEA,eAAO,EAAEa,YAAF,EAASb,yBAAiBe,QAAjB,EAA8BC,OAA9B,CAAT,EAAP;AAEH,KAlCM,EAkCJ,KAlCI,CAAP;AAoCH,CAjDM;;AAmDP,IAAMC,iBAAiB,SAAjBA,cAAiB,SAAU;AAAA;AAAA,4EAmD7B;AAAA;;AAAA,gBAA0BJ,KAA1B,SAA0BA,KAA1B;AAAA,gBAAiCb,UAAjC,SAAiCA,UAAjC;AAAA;AAAA;AAAA;AAAA;AACIa,qCAAS,KAAKK,EAAL,gCAAWL,KAAX,EAAT;;AADJ,gCAESb,UAFT;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAGI,iCAAKmB,OAAL,GAAeC,aAAa,KAAKD,OAAlB,CAAf;AACAE,6CAAiB,KAAKF,OAAtB,EAA+BnB,UAA/B,EAA2C;AAAA,uCAAQ,OAAO,OAAKmB,OAAL,CAAaG,IAAb,CAAf;AAAA,6BAA3C;;AAJJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAnD6B;;AAAA,wBAmDdC,QAnDc;AAAA;AAAA;AAAA;;AAE7BC,WAAOC,OAAP,CAAeC,UAAf,GAA4B,UAASC,OAAT,EAAkB;AAC1C,aAAKC,QAAL,GAAgBD,OAAhB;AACA,eAAO,IAAP;AACH,KAHD;;AAF6B,QAOrB/B,QAPqB,GAOR4B,OAAOG,OAPC,CAOrB/B,QAPqB;;;AAS7B,QAAMiC,wBAAwB,SAAxBA,qBAAwB,CAAC/B,MAAD,EAASgC,QAAT;AAAA;AAAA,+EAAsB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,wCAEvC,KAAKC,WAAL,CAAiBC,IAAjB,KAA0B,OAA1B,IAAqC,KAAKL,OAA3C,IACC,KAAKI,WAAL,CAAiBC,IAAjB,KAA0B,OAA1B,IAAqC,KAAKJ,QAD3C,IACwD,EAHhB,EACxC/B,IADwC,SACxCA,IADwC;AAI1CoC,2CAJ0C,GAI5BtC,eAAeC,QAAf,EAAyBC,IAAzB,EAA+BC,MAA/B,CAJ4B;AAKhD;AACA;;AANgD,oCAO3CmC,WAP2C;AAAA;AAAA;AAAA;;AAAA,iEAOvBC,QAAQC,MAAR,CAAe,IAAIC,wBAAJ,EAAf,CAPuB;;AAAA;AAAA;AAAA,uCAQ1CN,SAASO,IAAT,CAAc,IAAd,EAAoBJ,WAApB,CAR0C;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAAtB;;AAAA,qBAAqCK,oBAArC;AAAA;AAAA;;AAAA,mBAAqCA,oBAArC;AAAA;AAAA,KAA9B;;AAWA,QAAMlB,eAAe,SAAfA,YAAe,SAAU;AAC3B,YAAMmB,SAAS,EAAf;AACA,sCAAkBf,MAAlB,EAA0B,gBAAQ;AAC9B;AACAF,mBAAOA,KAAKrB,KAAL,CAAW,GAAX,EAAgBC,MAAhB,CAAuB,UAACC,IAAD,EAAOqC,GAAP,EAAe;AACzC,oBAAMC,UAAUC,MAAMD,OAAN,CAAcE,iBAAEC,GAAF,CAAMC,MAAN,EAAc1C,IAAd,CAAd,CAAhB;AACA,uBAAOsC,UAAUtC,IAAV,GAAoBA,IAApB,SAA4BqC,GAAnC;AACH,aAHM,CAAP;AAIA,gBAAMM,QAAQH,iBAAEC,GAAF,CAAMC,MAAN,EAAcvB,IAAd,CAAd;AACA,gBAAIwB,KAAJ,EAAWP,OAAOjB,IAAP,IAAewB,KAAf;AACd,SARD;AASA,eAAOP,MAAP;AACH,KAZD;;AAcA,QAAMlB,mBAAmB,SAAnBA,gBAAmB,CAACwB,MAAD,EAAS7C,UAAT,EAAqB+C,OAArB,EAAiC;AACtD,YAAMC,YAAYhD,WAAWiD,OAAOC,IAAP,CAAYlD,UAAZ,EAAwB,CAAxB,CAAX,MAA2C,CAA7D;AACA,YAAMmD,gBAAgB,SAAhBA,aAAgB;AAAA,mBAASH,aAAahD,WAAWsB,IAAX,MAAqB,CAAnC,IAA0C,CAAC0B,SAAD,IAAc,CAAChD,WAAWsB,IAAX,CAAjE;AAAA,SAAtB;AACA2B,eAAOC,IAAP,CAAYL,MAAZ,EAAoBO,MAApB,CAA2BD,aAA3B,EAA0CE,OAA1C,CAAkD;AAAA,mBAAQN,QAAQzB,IAAR,CAAR;AAAA,SAAlD;AACH,KAJD;;AAMA,aAASgC,MAAT,QAAgC;AAAA;;AAAA,YAAdtD,UAAc,SAAdA,UAAc;;AAC5B,YAAI,CAACA,UAAL,EAAiB;AACjB,YAAMuD,gBAAgBnC,aAAa,KAAKoC,IAAlB,CAAtB;AACAnC,yBAAiBkC,aAAjB,EAAgCvD,UAAhC,EAA4C;AAAA,mBAAQ,MAAKyD,GAAL,CAASnC,IAAT,EAAeoC,SAAf,CAAR;AAAA,SAA5C;AACH;;AAED,aAASC,MAAT,QAAuC;AAAA,YAArB9C,KAAqB,SAArBA,KAAqB;AAAA,YAAdb,UAAc,SAAdA,UAAc;;AACnCa,iBAAS,KAAKK,EAAL,gCAAWL,KAAX,EAAT;AACAb,sBAAc,KAAK4D,MAAL,CAAY5D,UAAZ,CAAd;AACH;;AASDwB,WAAOqC,GAAP,CAAW,MAAX,EAAmBhC,sBAAsB,QAAtB,EAAgCyB,MAAhC,CAAnB;AACA9B,WAAOqC,GAAP,CAAW,MAAX,EAAmBhC,sBAAsB,MAAtB,EAA8B8B,MAA9B,CAAnB;AACAnC,WAAOqC,GAAP,CAAW,SAAX,EAAsBhC,sBAAsB,MAAtB,EAA8B8B,MAA9B,CAAtB;AACAnC,WAAOqC,GAAP,CAAW,kBAAX,EAA+BhC,sBAAsB,QAAtB,EAAgCN,QAAhC,CAA/B;AACAC,WAAOqC,GAAP,CAAW,kBAAX,EAA+BhC,sBAAsB,QAAtB,EAAgC8B,MAAhC,CAA/B;AACAnC,WAAOqC,GAAP,CAAW,kBAAX,EAA+BhC,sBAAsB,QAAtB,EAAgC8B,MAAhC,CAA/B;AAEH,CAjED;;kBAmEe1C,c","file":"security.js","sourcesContent":["import _ from \"lodash\";\r\nimport { eachPathRecursive } from \"./utils\";\r\nimport { AccessDeniedError } from \"../error\";\r\n\r\nconst ALL = \"ALL\";\r\nconst ADMIN = \"ADMIN\";\r\nconst ADMIN_READ = \"ADMIN_READ\";\r\n\r\nexport const getPermissions = (security, user, action) => {\r\n\r\n    if (!user) return true;\r\n\r\n    const projectionToObject = projection => {\r\n        if (typeof projection === \"object\") return projection;\r\n        return projection.split(\" \").reduce((prev, field) => {\r\n            const excluding = field.startsWith(\"-\");\r\n            if (excluding) field = field.replace(\"-\", \"\");\r\n            return { ...prev, [field]: excluding ? 0 : 1 };\r\n        }, {});\r\n    };\r\n\r\n    return user.roles.reduce((prevPermission, role) => {\r\n\r\n        if (prevPermission === true ||\r\n                (role === ADMIN && !security.ADMIN && !security.ALL) ||\r\n                (action === \"read\" && role === ADMIN_READ && !security.ADMIN_READ && !security.ALL)) {\r\n            return true;\r\n        }\r\n\r\n        if (!security) return false;\r\n\r\n        const rolePermissions = security[role] || security[ALL] || {};\r\n        let permission = rolePermissions[action];\r\n        if (permission === true) {\r\n            return true;\r\n        }\r\n        \r\n        if (!permission) {\r\n            return prevPermission;\r\n        }\r\n\r\n        if (typeof rolePermissions !== \"object\") {\r\n            return prevPermission;\r\n        }\r\n\r\n        let where;\r\n        if (permission.where) {\r\n            where = prevPermission.where || [];\r\n            where.push(permission.where(user));\r\n        }\r\n        const prevProj = (prevPermission.projection && projectionToObject(prevPermission.projection)) || {};\r\n        const curProj = (permission.projection && projectionToObject(permission.projection)) || {};\r\n\r\n        return { where, projection: { ...prevProj, ...curProj } };\r\n\r\n    }, false);\r\n\r\n};\r\n\r\nconst securityPlugin = schema => {\r\n\r\n    schema.methods.setOptions = function(options) {\r\n        this._options = options;\r\n        return this;\r\n    };\r\n\r\n    const { security } = schema.options;\r\n\r\n    const createSecurityHandler = (action, callback) => async function querySecurityHandler() {\r\n        const { user } = \r\n                (this.constructor.name === \"Query\" && this.options) ||\r\n                (this.constructor.name === \"model\" && this._options) || {};\r\n        const permissions = getPermissions(security, user, action);\r\n        // Throwing error does not stop execution chain while saving.\r\n        // Promise rejecting works in all cases.\r\n        if (!permissions) return Promise.reject(new AccessDeniedError());\r\n        await callback.call(this, permissions);\r\n    };\r\n\r\n    const normalizeSet = object => {\r\n        const result = {};\r\n        eachPathRecursive(schema, path => {\r\n            // Reducing path to first array\r\n            path = path.split(\".\").reduce((prev, cur) => {\r\n                const isArray = Array.isArray(_.get(object, prev));\r\n                return isArray ? prev : `${prev}.${cur}`;\r\n            });\r\n            const value = _.get(object, path);\r\n            if (value) result[path] = value;\r\n        });\r\n        return result;\r\n    };\r\n\r\n    const handleRestricted = (object, projection, handler) => {\r\n        const exclusive = projection[Object.keys(projection)[0]] === 0;\r\n        const excludeFilter = path => (exclusive && projection[path] === 0) || (!exclusive && !projection[path]);\r\n        Object.keys(object).filter(excludeFilter).forEach(path => handler(path));\r\n    };\r\n\r\n    function onSave({ projection }) {\r\n        if (!projection) return;\r\n        const normalizedDoc = normalizeSet(this._doc);\r\n        handleRestricted(normalizedDoc, projection, path => this.set(path, undefined));\r\n    }\r\n\r\n    function onRead({ where, projection }) {\r\n        where && this.or(...where);\r\n        projection && this.select(projection);\r\n    }\r\n\r\n    async function onUpdate({ where, projection }) {\r\n        where && this.or(...where);\r\n        if (!projection) return;\r\n        this._update = normalizeSet(this._update);\r\n        handleRestricted(this._update, projection, path => delete this._update[path]);\r\n    }\r\n\r\n    schema.pre(\"save\", createSecurityHandler(\"create\", onSave));\r\n    schema.pre(\"find\", createSecurityHandler(\"read\", onRead));\r\n    schema.pre(\"findOne\", createSecurityHandler(\"read\", onRead));\r\n    schema.pre(\"findOneAndUpdate\", createSecurityHandler(\"update\", onUpdate));\r\n    schema.pre(\"findOneAndRemove\", createSecurityHandler(\"delete\", onRead));\r\n    schema.pre(\"findOneAndDelete\", createSecurityHandler(\"delete\", onRead));\r\n\r\n};\r\n\r\nexport default securityPlugin;"]}